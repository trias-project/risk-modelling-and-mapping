#--------------------------------------------
#-----------  Load packages  ----------------
#--------------------------------------------
packages <- c("curl", "zen4R", "here", "sf", "terra")

for(package in packages) {
  print(package)
  if( ! package %in% rownames(installed.packages()) ) { install.packages( package ) }
  library(package, character.only = TRUE)
}


#--------------------------------------------
#--------- Source helper functions ----------
#--------------------------------------------
source("./src/helper_functions.R")


#--------------------------------------------
#------------ Define folder paths -----------
#--------------------------------------------
habitat_folder <- file.path("./data/external/habitat")
Belgium_folder <- file.path("./data/external/GIS/Belgium")
Europe_folder <- file.path("./data/external/GIS/Europe")
Ecoregions_folder <- file.path("./data/external/GIS")
rcp26_belgium_eumodel_folder <- file.path("./data/external/climate/byEEA_finalRCP/belgium_rcps/rcp26")
rcp45_belgium_eumodel_folder <- file.path("./data/external/climate/byEEA_finalRCP/belgium_rcps/rcp45")
rcp85_belgium_eumodel_folder <- file.path("./data/external/climate/byEEA_finalRCP/belgium_rcps/rcp85")
chelsa_eu_folder <- file.path("./data/external/climate/chelsa_eu_clips")
rcp26_belgium_globalmodel_folder <- file.path("./data/external/climate/Global_finalRCP/belgium_rcps/rcp26")
rcp45_belgium_globalmodel_folder <- file.path("./data/external/climate/Global_finalRCP/belgium_rcps/rcp45")
rcp85_belgium_globalmodel_folder <- file.path("./data/external/climate/Global_finalRCP/belgium_rcps/rcp85")
rcp26_globalmodel_folder <- file.path("./data/external/climate/Global_finalRCP/rcp26")
rcp45_globalmodel_folder <- file.path("./data/external/climate/Global_finalRCP/rcp45")
rcp85_globalmodel_folder <- file.path("./data/external/climate/Global_finalRCP/rcp85")
eu_climate_folder <- file.path("./data/external/climate/rmi_corrected")
global_climate_folder <- file.path("./data/external/climate/trias_CHELSA")
biasgrids_folder <- file.path("./data/external/bias_grids/final/trias")


#-------------------------------------------------
#--------------- Create EU folders ---------------
#-------------------------------------------------
# Define the folder paths
folder_paths<-list(list("path"= habitat_folder,
                        "name"= "habitat"),
                   list("path"= Belgium_folder,
                        "name"= "Belgium"),
                   list("path"= Europe_folder,
                        "name"= "Europe"),
                   list("path"= Ecoregions_folder,
                        "name"= "official"),
                   list("path"= rcp26_belgium_eumodel_folder,
                        "name"= "rcp26"),
                   list("path"= rcp45_belgium_eumodel_folder,
                        "name"= "rcp45"),
                   list("path"= rcp85_belgium_eumodel_folder,
                        "name"= "rcp85"),
                   list("path"= chelsa_eu_folder,
                        "name"= "chelsa_eu_clips"),
                   list("path"= rcp26_belgium_globalmodel_folder,
                        "name"= "rcp26"),
                   list("path"= rcp45_belgium_globalmodel_folder,
                        "name"= "rcp45"),
                   list("path"= rcp85_belgium_globalmodel_folder,
                        "name"= "rcp85"),
                   list("path"= rcp26_globalmodel_folder,
                        "name"= "rcp26"),
                   list("path"= rcp45_globalmodel_folder,
                        "name"= "rcp45"),
                   list("path"= rcp85_globalmodel_folder,
                        "name"= "rcp85"),
                   list("path"=eu_climate_folder,
                        "name"= "rmi_corrected"),
                   list("path"= global_climate_folder,
                        "name"= "trias_CHELSA"),
                   list("path"= biasgrids_folder,
                        "name"= "trias"))

# Check and create each folder if necessary
lapply(folder_paths, function(folder){
  create_folder(folder$path, folder$name)
})


#-------------------------------------------------
#------ Store WWF ecoregions file   --------------
#-------------------------------------------------
curl::curl_download("http://assets.worldwildlife.org/publications/15/files/original/official_teow.zip?1349272619", destfile = paste0(Ecoregions_folder,"/official.zip"))
unzip(paste0(Ecoregions_folder,"/official.zip"), exdir = paste0(Ecoregions_folder,"/official"))
unlink(paste0(Ecoregions_folder,"/official.zip"))


#-------------------------------------------------
#------ Store the CHELSA layers  --------------
#-------------------------------------------------
options(timeout = 600) #set time-out to 10 min 

for(i in c("01", "04", "05", "06","07", "12","13","14","15")){
  
  # Define CHELSA layer name
  layer_name <- switch(i,
                       "01" = "meantemp",
                       "04" = "temp_seasonality",
                       "05" = "maxTmpWarmestMon",
                       "06"= "minTmpColdestMon",
                       "07"="temp_annRange",
                       "12"="annPrecip",
                       "13"="precipWettestMon",
                       "14"="precipDriestMon",
                       "15"="precipSeasonality")
  
  if(grepl("windows", Sys.getenv("OS"), ignore.case = TRUE)) {
    download.file(url = paste0("https://os.zhdk.cloud.switch.ch/chelsav1/climatologies/bio/CHELSA_bio10_",i,".tif"),
                  mode = "wb",
                  destfile = file.path(global_climate_folder,paste0("CHELSA_",layer_name,"_",i,".tif")))
  }else{
    download.file(url = paste0("https://os.zhdk.cloud.switch.ch/chelsav1/climatologies/bio/CHELSA_bio10_",i,".tif"),
                  destfile = file.path(global_climate_folder,paste0("CHELSA_",layer_name,"_",i,".tif")))
  }
}


#-------------------------------------------------
#-- Store habitat layers for the European model --
#-------------------------------------------------
download_zenodo(doi="https://doi.org/10.5281/zenodo.7841324", 
                path=habitat_folder, 
                quiet=FALSE)


#-------------------------------------------------
#- Store climate layers for the European model  --
#-------------------------------------------------
download_zenodo(doi="https://doi.org/10.5281/zenodo.15102496", 
                path=eu_climate_folder, 
                files=list("var10_30yrMeanAnnualCumulatedGDDAbove5degreesC_historical_1971_2005_Europe.tif",
                           "var11_AnnualMeanPotentialEvapotranspiration_historical_1971_2005_Europe.tif",
                           "var12_AnnualMeanSolarRadiation_historical_1971_2005_Europe.tif",
                           "var13_AnnualVariationSolarRadiation_historical_1971_2005_Europe.tif",
                           "var1_AnnualMeanTemperature_historical_1971_2005_Europe.tif",
                           "var2_AnnualAmountPrecipitation_historical_1971_2005_Europe.tif",
                           "var3_AnnualVariationPrecipitation_historical_1971_2005_Europe.tif",
                           "var4_AnnualVariationTemperature_historical_1971_2005_Europe.tif",
                           "var5_MaximumTemperatureWarmestMonth_historical_1971_2005_Europe.tif",
                           "var6_MinimumTemperatureColdestMonth_historical_1971_2005_Europe.tif",
                           "var7_TemperatureAnnualRange_historical_1971_2005_Europe.tif",
                           "var8_PrecipitationWettestMonth_historical_1971_2005_Europe.tif",
                           "var9_PrecipitationDriestMonth_historical_1971_2005_Europe.tif"), 
                quiet=FALSE)


