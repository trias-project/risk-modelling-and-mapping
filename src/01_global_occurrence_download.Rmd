---
title: "Download of global occurrence data"
author: 
  - name:  "Amy J.S Davis"
  - name:  "Peter Desmet" 
  - name:  "Damiano Oldoni"
  - name:  "Soria Delva"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: no
  html_notebook:
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: 
    toc_depth: '3'
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,error = TRUE)
```


```{r load libraries,echo=FALSE,message=FALSE}
options("rgdal_show_exportToProj4_warnings"="none")
library(purrr)
library(rgbif)
library(dplyr)
library(assertthat)
library(readr)
library(here)
library(trias)
```
### Basis of record


```{r define_basis_of_record_eu}
#All types of occurrences are downloaded, except `FOSSIL SPECIMEN` and `LIVING SPECIMEN`, which can have misleading location information (e.g. location of captive animal).

basis_of_record <- c(
  "OBSERVATION", 
  "HUMAN_OBSERVATION",
  "MATERIAL_SAMPLE",
  "PRESERVED_SPECIMEN", 
  "UNKNOWN", 
  "MACHINE_OBSERVATION",
  "OCCURRENCE"
)
```

### Specify time period to download occurrence data 
```{r define_year_eu}
year_begin <- 1971
year_end <-2010
```

### Download only georeferenced points

```{r define_hasCoordinate_eu}
hasCoordinate <- TRUE
```

### Trigger download

**Note**: GBIF credentials are required in the next step. 

Trigger download:

```{r trigger_gbif_download_eu}

 gbif_download_key <- occ_download(
   pred_in("taxonKey", taxon_key),
   pred_in("basisOfRecord", basis_of_record),
   pred_gte("year", year_begin),
   pred_lte("year", year_end),
  pred("hasCoordinate", hasCoordinate),
   user = rstudioapi::askForPassword("GBIF username"),
   pwd = rstudioapi::askForPassword("GBIF password"),
   email = rstudioapi::askForPassword("Email address for notification")
 )

occ_download_wait(gbif_download_key)#Check download status
```

###     Retrieve download

```{r retrieve_GBIF_download}
#gbif_download_key<-"0096867-240626123714530"
occ_download_get(gbif_download_key, path = here("data","raw"), overwrite=TRUE)
```

### Write download to list of downloads and check pending downloads:

```{r update_download_list_eu}
#If the file gbif_downloads.tsv does not exist, create and store an empty file
if(!file.exists(here::here("data", "raw", "gbif_downloads.tsv"))) {
  download_list<-data.frame(
    gbif_download_key= character(),
    input_checklist= character(),
    gbif_download_created=character(),
    gbif_download_status=character(),
    gbif_download_doi=character()
  )
  write_tsv(download_list, here::here("data", "raw", "gbif_downloads.tsv"))
  
  remove(download_list)
}

update_download_list(
  file = here::here("data", "raw", "gbif_downloads.tsv"), 
  download_to_add = gbif_download_key, 
  input_checklist = taxa_input_file
)
remove(taxa_input_file)
```

